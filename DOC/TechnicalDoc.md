# Deployment Stack - Docker CVE Scanner

## Overview

This repository provides an automated deployment script (`picbox.sh`) for a complete Docker-based infrastructure designed to scan and visualize Common Vulnerabilities and Exposures (CVEs) across a network. The stack is composed of modular services including:

- **Teleport** for secure access management
- **Portainer** for Docker management
- **UrBackup** for backups
- **PostgreSQL** as a CVE data store
- **Grafana** for CVE visualization
- **Nginx** as a reverse proxy with SSL support
- **Nmap + Vulners** CVE scanning
- **Zabbix Proxy** (optional) for monitoring



## Requirements

- Debian or Ubuntu-based system with at least 6 GIB of RAM
- Root or sudo privileges
- Public domain name (For Cloudflare and the domain name for the script)
- Internet connectivity
- Ports (The script handle this): 80, 443, 3022–3025, 3080, 3000, 9000, 55413, 35623/udp, 10051 (Zabbix)
- Exposed Ports : 443, 3080, 3022, 3023, 3025, 10051


## Quick Start

```bash
docker run -d \
  --name cloudflared \
  --restart unless-stopped \
  --network teleportpicinformatiquecom_cloudflared \
  cloudflare/cloudflared:latest \
  tunnel --no-autoupdate run --token <your_token_here>

docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' cloudflared

chmod +x deploy.sh
./deploy.sh
````

The script will guide you through an interactive configuration process.



## Interactive Setup Parameters

| Parameter                    | Description                                            |
| ---------------------------- | ------------------------------------------------------ |
| Project name                 | Root directory for all generated files                 |
| Public domain                | Used for HTTPS configuration (example.picinformatique.com) |
| SSL certificate type         | Choose between Let's Encrypt or self-signed            |
| Email (Let's Encrypt only)   | Required for Certbot registration                      |
| Deploy Zabbix proxy          | Optional monitoring via Zabbix                         |
| Zabbix proxy password        | Required if Zabbix is enabled                          |
| Initial scan                 | Launch an immediate scan post-deployment               |
| Scheduled scans              | Set up automated scan jobs via `cron`                  |
| Scan frequency               | Interval in days between scheduled scans               |
| Scan time                    | Time of day to run scans (HH\:MM, 24-hour format)      |
| Scan target                  | Target IP, range, or domain                            |
| Retain scan history          | Option to keep or overwrite old scan results           |
| PostgreSQL password          | Defaults to `dojo123` if left blank                    |
| Remove existing installation | Cleanup existing deployment before starting fresh      |



## Script Workflow

1. Validates or installs Docker, Buildx, Compose
2. Installs and enables `cron` for job scheduling
3. Generates project directory and configuration files:

   * `docker-compose.yaml`
   * Nginx config and SSL certificates
   * CVE scanning and parsing scripts
   * Teleport configuration
4. Launches the entire Docker stack
5. Sets up scheduled CVE scans if enabled



## CVE Scanning Process

* The `cve-scanner` container runs Nmap with the Vulners script
* Results are stored in XML format
* The `parser` container (Python) extracts:

  * IP, service, version, CVE ID, CVSS score, reference URL
* Parsed data is inserted into PostgreSQL for visualization



## Available Interfaces

All services are accessible securely via Teleport:

| Service   | URL                          |
| --------- | ---------------------------- |
| Teleport  | `https://<your-domain>`      |


Note: Self-signed certificates will trigger browser security warnings.



## Admin User Creation

To add an admin user in Teleport:

```bash
docker exec -it teleport tctl users add admin --roles=editor,access
```

A one-time invitation URL will be generated.

(**REMOVE THE 3080 FROM ALL THE URLS GENERATED BY TELEPORT**)



## Cron-Based Automation

If scheduled scans are enabled, a cron job will automatically:

* Execute an Nmap scan
* Parse and insert new results into PostgreSQL

Crons are configured via the system crontab with custom time and interval.



## Project Structure

```
<project_dir>/
├── config/                     # Teleport config
│   └── teleport.yaml
├── data/                       # Teleport runtime data
├── nginx/
│   ├── certs/                  # SSL certificates
│   └── conf.d/                 # Nginx configuration
├── cve-scanner/
│   ├── scans/                  # Raw scan XML results
│   └── scripts/
│       ├── scan.sh             # Nmap scan script
│       ├── parse_and_insert.py# Parser script
│       └── Dockerfile          # Parser container build
├── docker-compose.yaml         # Complete service definition
```



## Docker Images Used

| Image                                      | Purpose                  |
| ------------------------------------------ | ------------------------ |
| `nginx:alpine`                             | Reverse proxy            |
| `portainer/portainer-ce:2.27.6`            | Docker UI                |
| `uroni/urbackup-server`                    | Backup service           |
| `postgres:13`                              | CVE data storage         |
| `grafana/grafana`                          | Visualization            |
| `instrumentisto/nmap`                      | Nmap scanner             |
| `python:3.10-slim`                         | CVE parser               |
| `zabbix/zabbix-proxy-sqlite3` *(optional)* | Monitoring               |
| `teleport-distroless-debug:17.5.2`         | Secure access (Teleport) |

---

## Post-Deployment Recommendations

* Configure Grafana dashboards to query `vulnscan` database
* Set Teleport access policies (MFA, session TTL, RBAC)
* Implement image update strategy (e.g. `docker-compose pull`)
* Consider setting up log monitoring and alerting for critical CVEs

## Expose via Cloudflare Tunnel

To avoid exposing public ports directly, you can use a secure Cloudflare Tunnel:

```bash
docker run -d \
  --name cloudflared \
  --restart unless-stopped \
  --network <domaine_utilisé_pour_projet(ex:teleportpicinformatiquecom)>_cloudflared \
  cloudflare/cloudflared:latest \
  tunnel --no-autoupdate run --token <your_token_here> 
```

Refer to the Cloudflare documentation for detailed setup.


## Troubleshooting

| Issue                           | Solution                                                              |
| ------------------------------- | --------------------------------------------------------------------- |
| Let's Encrypt certificate fails | Ensure domain points to server and port 80 is open                    |
| Teleport not accessible         | Check container logs and verify Nginx reverse proxy configuration     |
| Cron jobs not running           | Verify `cron` is installed, enabled, and logs show successful runs    |
| Self-signed certificate errors  | Use a browser exception or switch to Let's Encrypt for public domains |
| cd errors  | Relaunch the script |
| Impossible to enroll a ssh server  | Disable the cloudflare 0 trust, deploy the server and enable it again |
| The script don't give the psk key  | cat /path/to/zabbix_proxy.psk ($PROJECT_DIR/psk/zabbix_proxy.psk)|
